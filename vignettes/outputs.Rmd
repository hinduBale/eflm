---
title: "Comparing 'glm' and 'eglm' outputs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Comparing 'glm' and 'eglm' output}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(eflm)
```

This vignette is adapted from 'glm' examples and the tests in R source code.

# A Gaussian example

This example with offsets comes from Venables & Ripley (2002, p.189). Please see the documentation for the [anorexia dataset](https://stat.ethz.ch/R-manual/R-devel/library/MASS/html/anorexia.html) from package 'MASS'.

Let's fit the model $Postwt_i = \beta_0 + \beta_1 Prewt_i + Treat_i + \varepsilon$ with 'glm':
```{r}
data(anorexia, package = "MASS")
model1 <- "Postwt ~ Prewt + Treat + offset(Prewt)" 
summary(glm(model1, family = gaussian, data = anorexia))
```

And now with 'eglm':
```{r}
summary(eglm(model1, family = gaussian, data = anorexia))
```

# A Gamma example

## Clotting dataset

The data was taken from McCullagh & Nelder (1989, pp. 300-2), where the original experiment comes from Hurn, et. al. (1945). The idea here is not just to compare 'glm' versus 'eglm', but also to compare `<family>$aic()` vs `logLik()` vs `AIC()`.

Input dataset:
```{r}
clotting <- data.frame(
  u    = c(5,10,15,20,30,40,60,80,100),
  lot1 = c(118,58,42,35,27,25,21,19,18),
  lot2 = c(69,35,26,21,18,16,13,12,12)
)
```

In this data:

* `u` is percentage concentration of normal blood plasma
* `lot1` is blood clotting time in seconds for clotting agent #1
* `lot2` is blood clotting time in seconds for clotting agent #2

## Model fitting

Here we shall fit the model $lot1_i^{-1} = \beta_0 + \beta_1 \log(u_i) + \varepsilon_i$ with both 'glm' and 'eglm':
```{r}
model1 <- "lot1 ~ log(u)"
summary(glm(model1, data = clotting, family = Gamma))
```
```{r}
summary(eglm(model1, data = clotting, family = Gamma))
```

And now $lot2_i^{-1} = \beta_0 + \beta_1 \log(u_i) + \varepsilon_i$ with both 'glm' and 'eglm':
```{r}
model2 <- "lot2 ~ log(u)"
summary(glm(model2, data = clotting, family = Gamma))
```
```{r}
summary(eglm(model2, data = clotting, family = Gamma))
```

## AIC comparison

Aside from summaries, we can compare the different AIC values for the first model with both 'glm' and 'eglm':
```{r}
fm1 <- glm(model1, data = clotting, family = Gamma)
fm2 <- eglm(model1, data = clotting, family = Gamma)

hasDisp <- 1 # have dispersion (here, but not e.g., for binomial, poisson)

# create function to compare AIC values
test_AIC <- function(L = list(fm1, fm2)) {
for(fm in L) {
  print(ll <- logLik(fm))
  p <- attr(ll, "df")
  A0 <- AIC(fm)
  A1 <- -2*c(ll) + 2*p
  aic.v <- fm$family$aic(
    y  = fm$y, mu = fitted(fm),
    wt = weights(fm), dev= deviance(fm)
  )
  stopifnot(
    p == (p. <- length(coef(fm))) + hasDisp,
    all.equal(-2*c(ll) + 2*hasDisp, aic.v) # <fam>$aic() = -2 * loglik + 2s
  )
  A2 <- aic.v + 2 * p.
  stopifnot(
    exprs = {
      all.equal(A0, A1)
      all.equal(A1, A2)
      all.equal(A1, fm$aic)
    }
  )
}
}

test_AIC()
```

And now the same as above for the second model:

```{r}
fm1 <- glm(model2, data = clotting, family = Gamma)
fm2 <- eglm(model2, data = clotting, family = Gamma)

test_AIC()
```

## Aliased singular

Now we fit the model $lot2_i^{-1} = \beta_0 + \beta_1 \log(u_i) + \beta_2 \log(u_i^2) + \varepsilon_i$. In this case, we can't estimate $\beta_2$ with 'glm' because of singularity:
```{r}
model3 <- "lot2 ~ log(u) + log(u^2)"
glm(model3, data = clotting, family = Gamma)
```

And the same applies to 'eglm':
```{r}
eglm(model3, data = clotting, family = Gamma)
```

# Case when the fit for the null deviance fails to converge

*See https://stat.ethz.ch/pipermail/r-help/2012-May/313161.html*

Initial parameters:
```{r}
Y <- c(rep(0,35),1,2,0,6,8,16,43)
beta <- 42:1
cst <- lchoose(42, beta)
tau <- (beta^2)/2
```

Output for 'glm' (here we expect an error!):
```{r, error = TRUE}
fail1 <- glm(formula = Y ~ offset(cst) + beta + tau, family = poisson)
```

Output for 'eglm':
```{r, error = TRUE}
fail2 <- eglm(formula = Y ~ offset(cst) + beta + tau, family = poisson)
```
*PENDING*: I need to replicate the same error!
